var okla = 1,
    dplayertitle = "拿去用不了哟";
if (diyvodid == 1) {
    var dmid = diyid,
        dmsid = diysid;
} else {
    var dmid = vodid,
        dmsid = vodsid;
}
// 初始化播放器
if (danmuon == 1) {
    var dp = new DPlayer({
        autoplay: autoplay,
        element: document.getElementById('player'),
        theme: color,
        logo: logo,
        video: {
            url: vodurl,
            pic: vodpic,
            type: "auto",
            // customType: {
            //     "customHls": function (video, player) {
            //         const engine = new p2pml.hlsjs.Engine();
            //         const hls = new Hls({
            //             liveSyncDurationCount: 7,
            //             loader: engine.createLoaderClass()
            //         });
            //         p2pml.hlsjs.initHlsJsPlayer(hls);
            //         hls.loadSource(video.src);
            //         hls.attachMedia(video);
            //     }
            // }
        },
        danmaku: {
            id: dmid,
            api: dmapi,
            token: 'dplayer',
            maximum: 1000,
            user: user,
            bottom: '15%',
            unlimited: true
        }

    });
    dp.danmaku.opacity(1);
} else {
    var dp = new DPlayer({
        autoplay: autoplay,
        element: document.getElementById('player'),
        theme: color,
        logo: logo,
        video: {
            url: vodurl,
            pic: vodpic,
            type: 'auto',
            // customType: {
            //     "customHls": function (video, player) {
            //         const engine = new p2pml.hlsjs.Engine();
            //         const hls = new Hls({
            //             liveSyncDurationCount: 7,
            //             loader: engine.createLoaderClass()
            //         });
            //         p2pml.hlsjs.initHlsJsPlayer(hls);
            //         hls.loadSource(video.src);
            //         hls.attachMedia(video);
            //     }
            // }
        },
    });
    $('body').addClass("danmu-off");
}


//封装操作localstorage本地存储的方法
var storage = {
        //存储
        set(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        },
        //取出数据
        get(key) {
            return JSON.parse(localStorage.getItem(key));
        },
        // 删除数据
        remove(key) {
            localStorage.removeItem(key);
        },
        // 清除数据
        clean() {
            window.localStorage.clear();
        }
    }
    // 广告处理
var Ad = {
        // 插入暂停广告
        playPause() {
            pause_ad == 1 ? $('#player').before(pause_ad_html) : '';
        },
        // 去除暂停广告
        outPause() {
            $('#player_pause').remove();
        }
    }
    // 浏览器检测
var Browser = {
    // 微信浏览器
    isWeixinBrowser() {
        var ua = navigator.userAgent.toLowerCase();
        // console.log(ua);
        return (/micromessenger/.test(ua)) ? true : false;
    }
}

// 域名检测跳转等等处理
var Author = {
    checkDomain() {
        var nameurl = document.domain.split('.').slice(-2).join('.')
        if (nameurl != 'qydmzz.com') {
            //alert(dplayertitle);
            location.href = 'https://www.qydmzz.com/'; //跳转地址
            okla = 0;
        } else {
            okla = 1;
        }
    },
    // 跳转到首页
    jumpIndex() {
        setTimeout(function() {
            if (okla == 0) {
                //alert(dplayertitle);
                location.href = 'https://www.qydmzz.com/'; //跳转地址
            } else if (okla == 2) {
                var device = document.getElementsByTagName('HEAD').item(0);
                var barh = document.createElement("script");
                device.appendChild(barh);
            }
        }, 5 * 1000);
    }
}

// 时间获取、格式化等处理
var Time = {
        // 获取播放进度时间 并格式化
        elapsed(playUrl) {
            return this.format(this.getPlay(playUrl));
        },
        //格式化时间
        format(seconds) {
            return [parseInt(seconds / 60 / 60), parseInt(seconds / 60 % 60), parseInt(seconds % 60)].join(":").replace(/\b(\d)\b/g, "0$1");
        },
        //获取播放进度时间
        getPlay(playUrl) {
            return Number(storage.get(playUrl));
        }
    }
    // 保存播放时长
var oldPlayTime = Time.getPlay(vodurl);

// 弹幕部分处理
var Danmu = {
    //添加弹幕列表
    addList(div1, div2, div3, div4) {
        $(div1).click(function() {
            $(div2).toggleClass(div3);
            $(div4).remove();
        });
    },
    // 弹幕列表
    showList() {
        $(".dplayer-list-icon").on("click", function() {
            $(".list-show").empty();
            $.ajax({
                url: dmapi + "?id=" + dmid + "&max=1000",
                success: function(data) {
                    if (data.code == 0) {
                        var danmaku = data.data;
                        // var title = danmaku.text;
                        $(".danmuku-num").text(danmaku.length)
                        $(danmaku).each(function(index, item) {
                            var dammulist = `<d class="danmuku-list" time="${item[0]}"><li>${Time.format(item[0])}</li><li title="${item[4]}">${item[4]}</li><li>${item[5]}</li></d>`
                                // var dammulist = `<d class="danmuku-list" time="${item[0]}"><li>${Time.format(item[0])}</li><li title="${item[4]}">${item[4]}</li><li title="用户：${item[3]}  IP地址：${item[5]}">${item[5]}</li><li class="report" onclick="Danmu.report(\'${item[5]}\',\'${title}\',\'${item[4]}\')">举报</li></d>`
                            $(".list-show").append(dammulist);
                        })
                    }
                    $(".danmuku-list").on("click", function() {
                        dp.seek($(this).attr("time"))
                    })
                }
            });
        });
    },
    sandData() {
        // 获取弹幕输入框数据
        var sendtexts = document.getElementById("dmtext").value;
        // 获取弹幕类型数据
        var sendtype = $('.dplayer-dplayer-comment-input').attr("dmtype");
        sendtype = other.type2Number(sendtype);
        // 获取弹幕颜色数据
        var sendcolor = $('.dplayer-comment-input').css("color");
        sendcolor = other.color2Number(other.colorRGBtoHex(sendcolor));
        var sendsize = $('.dplayer-dplayer-comment-input').attr("dmsize");
        // 过滤弹幕字符
        for (var i = 0; i < pbgjz.length; i++) {
            if (sendtexts.search(pbgjz[i]) != -1) {
                layer.tips('请勿发送时间、日期等无意义内容，弹幕不是实时的。您发送的内容将成为历史弹幕，展示给下一位观看者。', '#dmtext', {
                    tips: [1, '#444']
                });
                return;
            }
        }
        // 检测弹幕字符长度
        if (sendtexts.length < 2) {
            layer.msg("要输入弹幕内容啊喂！");
            return;
        } else {
            // author: "DIYgod"
            // color: 16777215
            // id: "87d733d55724b997ec21cd16bb3eda67"
            // text: "哈哈哈不错哦。很舒服"
            // time: 34.949118
            // type: 0
            // 发送弹幕数据 id：编号，text：内容，color：颜色，type：类型，reffer：引用站点链接
            dp.danmaku.send({ id: dmid, text: sendtexts, color: sendcolor, type: sendtype, reffer: REFERER, size: sendsize });
        }
        // 清除弹幕输入框
        $(".dplayer-dplayer-comment-input").val("");
    },
    // 绑定弹幕发送（点击图标）
    Click() {
        $(".dplayer-dplayer-send-icon").on("click", function() {
            Danmu.sandData();
        });
    },
    // 绑定弹幕发送（回车）
    Key() {
        $('#dmtext').bind('keypress', function(event) {
            if (event.keyCode == "13") {
                Danmu.sandData();
            }
        });
    },
    // 弹幕颜色切换
    Color() {
        $(".dplayer-comment-setting-color input").on("click", function() {
            var textcolor = $(this).attr("value");
            setTimeout(function() {
                $('.dplayer-dplayer-comment-input').css({ "color": textcolor });
            }, 100);
        });
    },
    // 弹幕类型切换
    Type() {
        $(".dplayer-comment-setting-type input").on("click", function() {
            var texttype = $(this).attr("value");
            setTimeout(function() {
                $('.dplayer-dplayer-comment-input').attr("dmtype", texttype);
            }, 100);
        });
    },
    // 弹幕字体大小切换
    Size() {
        $(".dplayer-comment-setting-font input").on("click", function() {
            var textsize = $(this).attr("value");
            setTimeout(function() {
                $('.dplayer-dplayer-comment-input').attr("dmsize", textsize);
            }, 100);
        });
    },
    // 弹幕设置窗口
    setBox() {
        $("#dmset").on("click", function() {
            $(".dplayer-comment-icon").trigger("click");
            $(".dplayer-comment-setting-box").toggleClass("dplayer-comment-setting-open")
            $("#dplayer").toggleClass("dplayer-hide-controller")
        });
    }
    /* ,
        report(user, title, text) {
            layer.confirm('' + text + '', {
                anim: 1,
                title: '举报弹幕',
                btn: ['违法违禁', '色情低俗', '恶意刷屏', '赌博诈骗', '人身攻击', '侵犯隐私', '垃圾广告', '剧透', '引战'],
                btn3: function(index, layero) {
                    Danmu.sendRport(user, title, text, '恶意刷屏');
                },
                btn4: function(index, layero) {
                    Danmu.sendRport(user, title, text, '赌博诈骗');
                },
                btn5: function(index, layero) {
                    Danmu.sendRport(user, title, text, '人身攻击');
                },
                btn6: function(index, layero) {
                    Danmu.sendRport(user, title, text, '侵犯隐私');
                },
                btn7: function(index, layero) {
                    Danmu.sendRport(user, title, text, '垃圾广告');
                },
                btn8: function(index, layero) {
                    Danmu.sendRport(user, title, text, '剧透');
                },
                btn9: function(index, layero) {
                    Danmu.sendRport(user, title, text, '引战');
                }
            }, function(index, layero) {
                Danmu.sendRport(user, title, text, '违法违禁');
            }, function(index) {
                Danmu.sendRport(user, title, text, '色情低俗');
            });
        },
        sendRport(user, title, text, type) {
            $.ajax({
                type: "get",
                url: dmapi + 'report/?user=' + user + '&title=' + title + '&text=' + text + '&type=' + type,
                cache: false,
                dataType: 'json',
                beforeSend: function() {

                },
                success: function(data) {
                    //layer.msg(data.msg);
                    layer.msg("举报成功！感谢您为守护弹幕作出了贡献");
                },
                error: function(data) {
                    var msg = "服务故障 or 网络异常，稍后再试！";
                    layer.msg(msg);
                }
            });
        } */
}

// 样式处理部分
var Css = {
    // 小电视播放按钮
    playIcon() {
        $(".dplayer-showing").on("click", function() {
            dp.play();
            $(".vod-pic").remove();
        });
    },
    // 移除loading-box
    cleanLoadingBox() {
        if (laoding == 1) {
            // 判断为微信浏览器，删除loading-box
            if (Browser.isWeixinBrowser()) {
                var css = '<style type="text/css">';
                css += '#loading-box{display: none;}';
                css += '</style>';
                $('body').append(css).addClass("");
            }
        } else {
            var css = '<style type="text/css">';
            css += '#loading-box{display: none;}';
            css += '</style>';
            $('body').append(css).addClass("");
        }
    },

    feadIn() {
        // var liyi_html = '<div class="dmrules"><a target="_blank" href="' + dmrule + '">弹幕礼仪</a></div>';
        // $("div.dplayer-comment-box:last").append(liyi_html);
        other.timeFade("#link1", 500);
        other.timeFade("#link2", 1000);
        danmuon == 1 ? other.timeFade("#link3,#span", 2 * 1000) : other.timeFade("#link3,#span", 1 * 1000);
    },
}

var dpHandler = {
    // 加载播放时间
    loadedmetadataHandler(playUrl) {
        if (Time.getPlay(playUrl) > 0 && dp.video.currentTime < Time.getPlay(playUrl)) {
            other.timeFunc(dpWork.videoConPlay(playUrl), 1000);
        } else {
            dp.notice("视频已准备就绪，即将为您播放");
            other.timeFunc(dpWork.videoPlay(), 1000);
        }
    },
    //播放时间记录
    timeupdateHandler(playUrl) {
        dp.on("timeupdate", function() {
            storage.set(playUrl, dp.video.currentTime);
        });
    },
    //播放结束下一集
    endedHandler() {
        if (next) {
            dp.notice("将自动为您播放下一集");
            dp.destroy();
            other.timeFunc(this.videoEnd(), 1 * 1000);
        } else {
            dp.notice("视频播放已结束");
            dp.destroy();
        }
    },
    // 播放下一集
    videoNext() {
        if (playnext != '') {
            dp.destroy();
            window.parent.location.href = playnext;
        } else {
            if (Time.getPlay(playUrl) > 0 && dp.video.currentTime < Time.getPlay(playUrl)) {
                dp.notice("已经是最后一集了哦");
            } else {
                dp.on('ended', function () {
                    dp.notice("视频播放已结束");
                    dp.destroy();
                });
            }
        }
    },
    // 播放结束下一集
    videoEnd() {
        // 支持iframe跨域
        // dp.on('ended', function() {
        dp.notice("将自动为您播放下一集");
        dp.destroy();
        window.parent.postMessage({
            msg: "playnext"
        }, '*');
        // });
    }
}

var dpWork = {
    // 点击取消dp全屏
    cancelFullScreen() {
        $(".dplayer-fulloff-icon").on("click", function() {
            dp.fullScreen.cancel();
        })
    },
    // 开始播放并移除加载进度
    videoPlay() {
        $("#link3").text("视频已准备就绪，即将为您播放");
        setTimeout(function() {
            dp.play();
            $("#loading-box").remove();
        }, 1 * 1500);
    },
    // 播放进度定位
    videoSeek() {
        dp.seek(oldPlayTime);
    },
    // 继续播放
    videoConPlay(playUrl) {
        var time = Time.elapsed(playUrl);
        if (laoding) {
            var conplayer = `<e>已播放至${time}，继续上次播放？</e><d class="conplay-jump">是 <i id="num">10</i>s</d><d class="conplaying">否</d>`
            $("#link3").html(conplayer);
            var span = document.getElementById('num');
            var num = span.innerHTML;
            var timer = null;
            setTimeout(function() {
                timer = setInterval(function() {
                    num--;
                    span.innerHTML = num;
                    if (num === 0) {
                        clearInterval(timer);
                        dpWork.videoSeek();
                        $("#laoding-pic,.memory-play-wrap,#loading-box").remove();
                        dp.play();
                    }
                }, 1000);
            }, 1);
        } else {
            dp.play();
        }
        var cplayer = `<div class="memory-play-wrap"><div class="memory-play"><span class="close">×</span><span>上次看到 </span><span>${time}</span><span class="play-jump">跳转播放</span></div></div>`
        $(".dplayer-cplayer").append(cplayer);
        $(".close").on("click", function() {
            $(".memory-play-wrap").remove();
        });
        other.timeRemove(".memory-play-wrap", 20 * 1000);
        $(".conplaying").on("click", function() {
            clearTimeout(timer);
            $("#laoding-pic,#loading-box").remove();
            dp.play();
        });
        $(".conplay-jump,.play-jump").on("click", function() {
            dpWork.videoSeek();
            clearTimeout(timer);
            $("#laoding-pic,.memory-play-wrap,#loading-box").remove();
            dp.play();
        });
    },
}

var other = {
    // 弹幕颜色 RGB转HEX
    colorRGBtoHex(color) {
        var rgb = color.split(',');
        var r = parseInt(rgb[0].split('(')[1]);
        var g = parseInt(rgb[1]);
        var b = parseInt(rgb[2].split(')')[0]);
        var hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        return hex;
    },
    // 弹幕颜色 HEX转数字
    color2Number(color) {
        if (color[0] === '#') {
            color = color.substr(1);
        }
        if (color.length === 3) {
            color = `${color[0]}${color[0]}${color[1]}${color[1]}${color[2]}${color[2]}`;
        }
        return parseInt(color, 16) + 0x000000 & 0xffffff;
    },
    // 弹幕类型转数字
    type2Number(type) {
        switch (type) {
            case 'right':
                return 0;
            case 'top':
                return 1;
            case 'bottom':
                return 2;
            default:
                return 0;
        }
    },
    timeFade(css, time) {
        setTimeout(function() {
            $(css).fadeIn();
        }, time);
    },
    timeRemove(css, time) {
        setTimeout(function() {
            $(css).remove();
        }, time);
    },
    timeFunc(fun, time) {
        setTimeout(function() {
            fun
        }, time);
    }
}

$(document).ready(function() {
    // 移除loading-box
    Css.cleanLoadingBox();
    // 域名授权检测
    Author.checkDomain();
    // 添加弹幕列表图标,列表图层
    Danmu.addList('.dplayer-list-icon', ".dplayer-danmu", 'show');
    next != '' ? '' : $(".icon-xj").remove();
    // 小电视播放按钮
    Css.playIcon();
    // 弹幕颜色切换
    Danmu.Color();
    // 弹幕类型切换
    Danmu.Type();
    // 弹幕文字大小切换
    Danmu.Size();
    // 弹幕设置窗口
    Danmu.setBox()
    // 绑定弹幕列表展示事件
    Danmu.showList();
    // 绑定弹幕发送（点击）
    Danmu.Click();
    // 绑定弹幕发送（回车）
    Danmu.Key();
    // 一些淡入淡出效果
    Css.feadIn();
    // 点击取消dp全屏
    dpWork.cancelFullScreen();
    // 跳转页加载
    Author.jumpIndex();
    // 插入在线人数
    window.onload = function() {
        $(".dplayer-watching-number").text(usernum);
    }
    // dp数据加载
    dp.on("loadedmetadata", function() {
        dpHandler.loadedmetadataHandler(vodurl);
    });
    // 视频下一集跳转处理
    dpHandler.videoNext();
    // 视频播放结束处理
    dp.on("ended", function() {
        dpHandler.endedHandler();
    });
    // 暂停广告处理
    dp.on('pause', function() {
        Ad.playPause();
    });
    // 取消暂停广告处理
    dp.on('play', function() {
        Ad.outPause();
        dpHandler.timeupdateHandler(vodurl);
    });
});